options:
  logging: CLOUD_LOGGING_ONLY

steps:
  # Create a Cloud Storage bucket for uploads if it doesn't exist
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - '-c'
      - |
        gsutil ls -b gs://baic-uploads || gsutil mb -l us-central1 gs://baic-uploads
        gsutil iam ch allUsers:objectViewer gs://baic-uploads

  # Deploy Admin Panel to App Engine
  - name: 'node:20'
    entrypoint: bash
    args:
      - '-c'
      - |
        cd beiqi-web-master/beiqi-web-master
        
        # Update the .env.production file with relative URLs to avoid mixed content issues
        echo "port = '80'" > .env.production
        echo "# 生产环境配置" >> .env.production
        echo "ENV = 'production'" >> .env.production
        echo "" >> .env.production
        echo "# 接口路径 - Using relative URL to avoid mixed content issues" >> .env.production
        echo "VUE_APP_BASE_API = '/api'" >> .env.production
        echo "" >> .env.production
        echo "# 文件路径" >> .env.production
        echo "VUE_APP_FILE_UOLOAD_HOST = '/file'" >> .env.production
        echo "" >> .env.production
        echo "# 页面标题" >> .env.production
        echo "VUE_APP_TITLE = 北汽官网后台管理系统" >> .env.production
        echo "" >> .env.production
        echo "#门户地址" >> .env.production
        echo "VUE_APP_WEB_HOST = 'https://baic-457613.appspot.com'" >> .env.production
        
        npm install
        npm run build:prod
        
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - '-c'
      - |
        cd beiqi-web-master/beiqi-web-master
        gcloud app deploy app.yaml --quiet

timeout: 1800s
